<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OSD – Driver Sign-Off (OCR + Barcode/QR)</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#4f46e5}
  *{box-sizing:border-box}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:var(--ink);margin:0}
  .container{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
  h1{font-size:28px;margin:8px 0 16px}
  label{display:block;font-size:13px;color:#475569;margin:8px 0 6px}
  input,textarea,select{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff}
  input:focus,textarea:focus,select:focus{border-color:var(--brand)}
  .grid{display:grid;gap:12px}
  @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn-ghost{background:#eef2ff;color:#111827;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  .alert{padding:10px 14px;border-radius:12px;margin:10px 0;font-weight:600}
  .alert.success{background:#e8f7ee;border:1px solid #31a24c;color:#166534}
  .alert.error{background:#fdeaea;border:1px solid #dc2626;color:#7f1d1d}
  .sig{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .sigbar{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px 10px}
  #sigCanvas{display:block;width:100%;height:180px;background:#f9fafb;touch-action:none}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:100px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;background:#f8fafc}
  pre{white-space:pre-wrap;background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:10px;max-height:200px;overflow:auto;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>OSD – Driver Sign-Off</h1>
  <div id="alert"></div>

  <form id="osdForm" class="card" novalidate>
    <div class="grid grid-2">
      <div>
        <label>Date/Time</label>
        <input type="datetime-local" id="date"/>
      </div>
      <div>
        <label>Door Number *</label>
        <select id="doorNumber" required></select>
      </div>
    </div>

    <div class="row card">
      <div class="field small">
        <label>BOL #</label>
        <input id="bol" placeholder="BOL #"/>
      </div>
      <div class="field small">
        <label>PO #</label>
        <input id="po" placeholder="PO #"/>
      </div>
      <div class="field">
        <label>Trailer #</label>
        <input id="trailer" placeholder="Trailer #"/>
      </div>
      <div class="field">
        <label>Carrier *</label>
        <input id="carrier" placeholder="Carrier" required/>
      </div>
    </div>

    <div class="card">
      <label>Upload or Take Photo of BOL <span id="ocrStatus" class="muted"></span></label>
      <input type="file" id="bolFile" accept="image/*,application/pdf" capture="environment"/>
      <div class="thumbs" id="bolPreview"></div>

      <div class="row" style="margin-top:8px">
        <button type="button" class="btn-ghost" id="scanBtn">Auto-Fill (OCR + QR)</button>
        <button type="button" class="btn-ghost" id="showText">Show OCR Text</button>
      </div>

      <div id="rawTextWrap" style="display:none;margin-top:8px">
        <pre id="rawText"></pre>
      </div>

      <label style="margin-top:10px">Digital BOL Link / Load Number (optional)</label>
      <input type="text" id="bolLink" placeholder="Paste link or enter load number"/>
    </div>

    <div class="row card">
      <div class="field small">
        <label>Vendor ID</label>
        <input id="vendorId" placeholder="Vendor ID"/>
      </div>
      <div class="field">
        <label>Vendor Name</label>
        <input id="vendorName" placeholder="Vendor Name"/>
      </div>
    </div>

    <div class="card">
      <label>Notes / Exceptions</label>
      <textarea id="notes" rows="4"></textarea>
    </div>

    <div class="row">
      <div class="field">
        <label>Driver Name *</label>
        <input id="driverName" required/>
      </div>
      <div class="field">
        <label>PRO # / Driver ID (optional)</label>
        <input id="proNumber" placeholder="PRO # or License"/>
      </div>
    </div>

    <div class="sig" style="margin-top:12px">
      <div class="sigbar">
        <span class="muted">Driver signature *</span>
        <button type="button" class="btn-ghost" id="clearSig">Clear</button>
      </div>
      <canvas id="sigCanvas"></canvas>
    </div>

    <div style="margin-top:12px">
      <label>Additional Photos (optional)</label>
      <input type="file" id="photos" multiple accept="image/*"/>
      <div class="thumbs" id="thumbs"></div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button type="button" class="btn-ghost" id="mailtoBtn">Send via Email</button>
      <button class="btn" id="submitBtn">Submit</button>
    </div>
  </form>
</div>

<script>
const BACKEND_URL = "https://osd-webform.onrender.com";
const $ = id => document.getElementById(id);
const alertBox = $('alert');

function setAlert(type,msg){
  alertBox.innerHTML = `<div class="alert ${type==='error'?'error':'success'}">${msg}</div>`;
  setTimeout(()=>alertBox.innerHTML='',6000);
}

/* Prefill Date */
(() => {
  const d = new Date(), p = n => String(n).padStart(2,'0');
  $('date').value = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
})();

/* Doors */
(() => {
  const sel = $('doorNumber');
  const def = document.createElement('option');
  def.value=''; def.textContent='Select Door';
  sel.appendChild(def);
  for(let i=1;i<=26;i++){
    let o=document.createElement('option');
    o.textContent=`Door ${i} – 6121 Bixby Rd`;
    o.value=o.textContent; sel.appendChild(o);
  }
  for(let i=1;i<=26;i++){
    let o=document.createElement('option');
    o.textContent=`Door ${i} – Other Building`;
    o.value=o.textContent; sel.appendChild(o);
  }
  for(let i=100;i<=140;i++){
    let o=document.createElement('option');
    o.textContent=`Door ${i}`; o.value=o.textContent;
    sel.appendChild(o);
  }
})();

/* Signature */
(() => {
  const c=$('sigCanvas'),x=c.getContext('2d');let draw=false;
  function resize(){const r=c.getBoundingClientRect(),d=window.devicePixelRatio||1;
    c.width=r.width*d;c.height=r.height*d;x.scale(d,d);x.lineWidth=2;x.lineCap='round';x.strokeStyle='#111827';}
  window.addEventListener('resize',resize);resize();
  function p(e){const r=c.getBoundingClientRect();if(e.touches){e=e.touches[0]}return{x:e.clientX-r.left,y:e.clientY-r.top};}
  c.addEventListener('mousedown',e=>{draw=true;const {x,y}=p(e);x0=x;y0=y;});
  c.addEventListener('mousemove',e=>{if(!draw)return;const {x,y}=p(e);x.beginPath();x.moveTo(x0,y0);x.lineTo(x,y);x.stroke();x0=x;y0=y;});
  c.addEventListener('mouseup',()=>draw=false);
  $('clearSig').onclick=()=>x.clearRect(0,0,c.width,c.height);
})();

/* OCR + Barcode */
async function scanImage(file){
  const img = new Image();
  img.src = URL.createObjectURL(file);
  await img.decode();
  const c = document.createElement('canvas');
  c.width = img.width; c.height = img.height;
  const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
  $('bolPreview').innerHTML='';
  $('bolPreview').appendChild(img);

  /* OCR text */
  const {data} = await Tesseract.recognize(c,'eng');
  const text = data.text || '';
  $('rawText').textContent = text;

  /* Barcode / QR decode */
  const hints = new ZXing.DecodeHintType();
  const reader = new ZXing.BrowserMultiFormatReader();
  let resultText='';
  try{
    const result = await reader.decodeFromImageElement(img);
    resultText = result.text || '';
  }catch(e){resultText='';}

  const combined = (text + ' ' + resultText).toUpperCase();
  const bolMatch = combined.match(/BOL[:#\s\-]*([A-Z0-9\-]+)/);
  const poMatch = combined.match(/PO[:#\s\-]*([A-Z0-9\-]+)/);
  const carrierMatch = combined.match(/CARRIER[:#\s\-]*([A-Z0-9\s]+)/);

  if(bolMatch) $('bol').value = bolMatch[1];
  if(poMatch) $('po').value = poMatch[1];
  if(carrierMatch) $('carrier').value = carrierMatch[1].trim();

  setAlert('success','Auto-filled from photo.');
}

$('scanBtn').onclick = async ()=>{
  const f=$('bolFile').files[0];
  if(!f){setAlert('error','Upload a photo first.');return;}
  await scanImage(f);
};

$('showText').onclick=()=>{const w=$('rawTextWrap');w.style.display=w.style.display==='none'?'block':'none';};

/* Submit */
$('submitBtn').onclick=async(e)=>{
  e.preventDefault();
  if(!$('doorNumber').value||!$('driverName').value||!$('carrier').value)
    return setAlert('error','Please complete all required fields.');
  const fd=new FormData();
  ['date','doorNumber','bol','po','trailer','carrier','vendorId','vendorName','notes','driverName','proNumber','bolLink']
    .forEach(k=>fd.append(k,$(k).value||''));
  fd.append('signature',$('sigCanvas').toDataURL('image/png'));
  if($('bolFile').files[0]) fd.append('bolFile',$('bolFile').files[0]);
  [...$('photos').files].forEach(f=>fd.append('photos',f));
  try{
    const res=await fetch(BACKEND_URL+'/submit',{method:'POST',body:fd});
    if(res.ok) setAlert('success','Submitted.');
    else setAlert('error','Submission failed.');
  }catch{setAlert('error','Network error.');}
};
</script>
</body>
</html>
