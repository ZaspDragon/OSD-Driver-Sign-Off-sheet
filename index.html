<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OSD – Driver Sign-Off</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#4f46e5}
  *{box-sizing:border-box}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:var(--ink);margin:0}
  .container{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
  h1{font-size:28px;margin:8px 0 16px}
  label{display:block;font-size:13px;color:#475569;margin:8px 0 6px}
  input,textarea,select{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff}
  input:focus,textarea:focus,select:focus{border-color:var(--brand)}
  .grid{display:grid;gap:12px}
  @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .field{flex:1 1 220px;min-width:160px}
  .field.small{flex:0 0 180px;min-width:150px}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:#eef2ff;color:#111827;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  .alert{padding:10px 14px;border-radius:12px;margin:10px 0;font-weight:600}
  .alert.success{background:#e8f7ee;border:1px solid #31a24c;color:#166534}
  .alert.error{background:#fdeaea;border:1px solid #dc2626;color:#7f1d1d}
  .sig{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .sigbar{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px 10px}
  #sigCanvas{display:block;width:100%;height:180px;background:#f9fafb;touch-action:none}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:100px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;background:#f8fafc}
</style>
</head>
<body>
<div class="container">
  <h1>OSD – Driver Sign-Off</h1>
  <div id="alert"></div>

  <form id="osdForm" class="card" novalidate>
    <div class="grid grid-2">
      <div>
        <label>Date/Time</label>
        <input type="datetime-local" id="date"/>
      </div>
      <div>
        <label>Door Number *</label>
        <select id="doorNumber" required></select>
      </div>
    </div>

    <!-- Compact row: BOL # + PO # -->
    <div class="row card" style="margin-top:12px">
      <div class="field small">
        <label for="bol">BOL #</label>
        <input id="bol" placeholder="BOL #"/>
      </div>
      <div class="field small">
        <label for="po">PO #</label>
        <input id="po" placeholder="PO #"/>
      </div>
      <div class="field">
        <label for="trailer">Trailer #</label>
        <input id="trailer" placeholder="Trailer #"/>
      </div>
      <div class="field">
        <label for="carrier">Carrier *</label>
        <input id="carrier" placeholder="Carrier" required/>
      </div>
    </div>

    <!-- BOL Upload (image OR PDF) + OCR + Digital Link -->
    <div class="card" style="margin-top:12px">
      <label>Photo or PDF of BOL <span id="ocrStatus" class="muted"></span></label>
      <input type="file" id="bolFile" accept="image/*,application/pdf"/>
      <div class="thumbs" id="bolPreview"></div>
      <div id="bolPdfBadge" class="pill" style="display:none">BOL PDF attached</div>

      <label style="margin-top:10px">Digital BOL Link / Load Number (optional)</label>
      <input type="text" id="bolLink" placeholder="Paste a link to the BOL or enter the load number"/>
    </div>

    <!-- Compact row: Vendor ID + Vendor Name + Stop # -->
    <div class="row card" style="margin-top:12px">
      <div class="field small">
        <label for="vendorId">Vendor ID</label>
        <input id="vendorId" placeholder="Vendor ID"/>
      </div>
      <div class="field">
        <label for="vendorName">Vendor Name</label>
        <input id="vendorName" placeholder="Vendor Name"/>
      </div>
      <div class="field small">
        <label for="stop">Stop #</label>
        <input id="stop" placeholder="Stop #"/>
      </div>
    </div>

    <div class="card">
      <label>Notes / Exceptions</label>
      <textarea id="notes" rows="5" placeholder="Possible damages, shortages, and overages..."></textarea>
    </div>

    <div class="row">
      <div class="field">
        <label for="driverName">Driver Name *</label>
        <input id="driverName" required/>
      </div>
      <div class="field">
        <label for="proNumber">PRO # / Driver ID (optional)</label>
        <input id="proNumber" placeholder="PRO # or License"/>
      </div>
    </div>

    <div class="sig" style="margin-top:12px">
      <div class="sigbar">
        <span class="muted">Driver signature (draw in the box) *</span>
        <button type="button" class="btn-ghost" id="clearSig">Clear</button>
      </div>
      <canvas id="sigCanvas"></canvas>
    </div>

    <div style="margin-top:12px">
      <label>Photos (optional)</label>
      <input type="file" id="photos" multiple accept="image/*"/>
      <div class="thumbs" id="thumbs"></div>
    </div>

    <!-- Email controls -->
    <div class="grid grid-2 card" style="margin-top:12px">
      <div>
        <label>Email To (comma-separated)</label>
        <input id="toEmail" placeholder="ops@company.com, manager@company.com"/>
      </div>
      <div>
        <label>CC (optional)</label>
        <input id="ccEmail" placeholder="qc@company.com"/>
      </div>
      <div>
        <label>BCC (optional)</label>
        <input id="bccEmail" placeholder="audit@company.com"/>
      </div>
      <div>
        <label>Subject (optional)</label>
        <input id="emailSubject" placeholder="OSD Sign-Off"/>
      </div>
    </div>

    <div class="card">
      <label>Email Message (optional)</label>
      <textarea id="emailMessage" rows="4" placeholder="Any extra context to include in the email body..."></textarea>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button type="button" class="btn-ghost" id="mailtoBtn">Send via Email App</button>
      <button class="btn" id="submitBtn">Submit (Generate & Email PDF)</button>
    </div>
  </form>
</div>

<script>
  // Use your deployed backend base URL (server.js exposes /api/osd/submit)
  const BACKEND_URL = "https://osd-webform.onrender.com";

  // Prefill datetime
  (function prefillDate(){
    const d = new Date(), p = n => String(n).padStart(2,'0');
    const val = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    document.getElementById('date').value = val;
  })();

  // Populate Door select with top code addresses AND 100–140 range
  (function fillDoors(){
    const sel = document.getElementById('doorNumber');
    const fixed = [
      "Door 17 – 6121 Bixby Rd, Canal Winchester OH 43110",
      "Door 18 – 6121 Bixby Rd, Canal Winchester OH 43110",
      "Door 19 – 6121 Bixby Rd, Canal Winchester OH 43110"
    ];
    const frag = document.createDocumentFragment();
    const add = (v) => { const o=document.createElement('option'); o.value=v; o.textContent=v; frag.appendChild(o); };
    const def = document.createElement('option'); def.value=""; def.textContent="Select Door"; frag.appendChild(def);
    fixed.forEach(add);
    for(let i=100;i<=140;i++){ add(`Door ${i}`); }
    sel.appendChild(frag);
  })();

  const alertBox  = document.getElementById('alert');
  const form      = document.getElementById('osdForm');
  const submitBtn = document.getElementById('submitBtn');

  // Signature pad
  const canvas = document.getElementById('sigCanvas');
  const ctx    = canvas.getContext('2d');
  let drawing=false, lastX=0, lastY=0;
  window.signatureDataUrl = "";

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width  = Math.floor(rect.width * ratio);
    canvas.height = Math.floor(180 * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111827';
  }
  resizeCanvas(); new ResizeObserver(resizeCanvas).observe(canvas);

  function pt(e){ const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
  canvas.addEventListener('pointerdown', e=>{ e.preventDefault(); drawing=true; const p=pt(e); lastX=p.x; lastY=p.y; });
  canvas.addEventListener('pointermove', e=>{ if(!drawing) return; const p=pt(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
  function endStroke(){ if(!drawing) return; drawing=false; window.signatureDataUrl = canvas.toDataURL('image/png'); }
  canvas.addEventListener('pointerup', endStroke);
  canvas.addEventListener('pointerleave', endStroke);
  canvas.addEventListener('pointercancel', endStroke);
  document.getElementById('clearSig').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); window.signatureDataUrl=""; });

  // Photos preview
  const photosInput = document.getElementById('photos');
  const thumbs      = document.getElementById('thumbs');
  photosInput.addEventListener('change', ()=>{
    thumbs.innerHTML=''; [...photosInput.files].forEach(file=>{
      const url = URL.createObjectURL(file); const img = document.createElement('img');
      img.src = url; img.onload=()=>URL.revokeObjectURL(url); thumbs.appendChild(img);
    });
  });

  // --- BOL image/PDF + OCR ---
  const bolFile = document.getElementById('bolFile');
  const bolPreview = document.getElementById('bolPreview');
  const bolPdfBadge = document.getElementById('bolPdfBadge');
  let bolPhotoDataUrl = '';
  let bolPdfDataUrl = '';

  bolFile.addEventListener('change', async () => {
    bolPreview.innerHTML=''; bolPdfBadge.style.display='none'; bolPhotoDataUrl=''; bolPdfDataUrl='';
    const f = bolFile.files?.[0]; if(!f) return;

    if (f.type && f.type.startsWith('image/')) {
      const url = URL.createObjectURL(f);
      const img = document.createElement('img'); img.src = url; img.onload = () => URL.revokeObjectURL(url);
      bolPreview.appendChild(img);

      // OCR
      try{
        const { data } = await Tesseract.recognize(url, 'eng');
        const text = data.text || '';
        const bolMatch = text.match(/(?:BOL|Bill of Lading|Load ID)\s*[:#-]?\s*([A-Z0-9-]+)/i);
        const poMatch  = text.match(/(?:PO|P\.?O\.?|Purchase Order)\s*[:#-]?\s*([A-Z0-9-]+)/i);
        if(bolMatch && !document.getElementById('bol').value) document.getElementById('bol').value = bolMatch[1];
        if(poMatch  && !document.getElementById('po').value)  document.getElementById('po').value  = poMatch[1];
        document.getElementById('ocrStatus').textContent = '• OCR filled detected fields';
      }catch(e){
        document.getElementById('ocrStatus').textContent = '• OCR failed (optional)';
      }

      // compress to jpeg data url
      bolPhotoDataUrl = await readImageAsDataURL(f);
    } else if (f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')) {
      const reader = new FileReader();
      bolPdfDataUrl = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(f);
      });
      bolPdfBadge.style.display='inline-block';
      document.getElementById('ocrStatus').textContent = '• PDF attached';
    } else {
      const reader = new FileReader();
      reader.onload = () => { bolPdfDataUrl = reader.result; bolPdfBadge.style.display='inline-block'; };
      reader.readAsDataURL(f);
      document.getElementById('ocrStatus').textContent = '• File attached';
    }
  });

  function readImageAsDataURL(file, maxW=1600, maxH=1600, quality=0.85){
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const ratio = Math.min(1, maxW/img.width, maxH/img.height);
          const c = document.createElement('canvas');
          c.width = Math.round(img.width*ratio);
          c.height = Math.round(img.height*ratio);
          const cx = c.getContext('2d');
          cx.drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg', quality));
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // Mailto fallback
  document.getElementById('mailtoBtn').addEventListener('click', () => {
    const fields = {
      date: document.getElementById('date').value,
      location: document.getElementById('doorNumber').value,
      bol: document.getElementById('bol').value,
      po: document.getElementById('po').value,
      bolLink: document.getElementById('bolLink').value,
      stop: document.getElementById('stop').value,
      carrier: document.getElementById('carrier').value,
      vendorId: document.getElementById('vendorId').value,
      vendorName: document.getElementById('vendorName').value,
      notes: document.getElementById('notes').value,
      driverName: document.getElementById('driverName').value,
      driverId: document.getElementById('proNumber').value
    };
    const subject = encodeURIComponent(`OSD Sign-Off: ${fields.driverName || 'Driver'} / ${fields.carrier || ''}`);
    const body = [
      'OSD – Driver Sign-Off (manual email)',
      '',
      `Date/Time: ${fields.date}`,
      `Door: ${fields.location}`,
      `BOL #: ${fields.bol}`,
      `PO #: ${fields.po}`,
      `Digital BOL Link / Load #: ${fields.bolLink}`,
      `Stop #: ${fields.stop}`,
      `Carrier: ${fields.carrier}`,
      `Vendor ID: ${fields.vendorId}`,
      `Vendor Name: ${fields.vendorName}`,
      '',
      `Driver: ${fields.driverName}`,
      `Driver ID: ${fields.driverId}`,
      '',
      'Notes:',
      fields.notes || '(none)',
      '',
      'Attachments: Please attach the BOL (photo or PDF) if needed.'
    ].join('\n');
    const href = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
    window.location.href = href;
  });

  // Submit
  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); alertBox.innerHTML='';

    const doorNumber = document.getElementById('doorNumber').value.trim();
    const driverName = document.getElementById('driverName').value.trim();
    const carrierVal = document.getElementById('carrier').value.trim();
    if(!doorNumber || !driverName || !carrierVal){
      alertBox.innerHTML = `<div class="alert error">Door Number, Driver Name, and Carrier are required.</div>`;
      return;
    }
    if(!window.signatureDataUrl){
      alertBox.innerHTML = `<div class="alert error">Signature is required.</div>`;
      return;
    }

    const files  = photosInput ? [...photosInput.files] : [];
    const photos = [];
    for(const f of files){ photos.push({ name:f.name, dataUrl: await readImageAsDataURL(f) }); }

    const payload = {
      date: document.getElementById('date').value || new Date().toISOString(),
      location: doorNumber,
      bol: document.getElementById('bol').value || '',
      po: document.getElementById('po').value || '',
      trailerNumber: document.getElementById('trailer').value || '',
      carrier: carrierVal,
      vendorId: document.getElementById('vendorId').value || '',
      vendorName: document.getElementById('vendorName').value || '',
      notes: document.getElementById('notes').value || '',
      driverName,
      driverId: document.getElementById('proNumber').value || '',
      signatureDataUrl: window.signatureDataUrl || '',
      bolPhotoDataUrl,
      bolPdfDataUrl,
      bolLink: document.getElementById('bolLink').value || '',
      stop: document.getElementById('stop').value || '',
      photos,
      device: navigator.userAgent,
      submittedAt: new Date().toISOString(),
      // optional email routing fields (used by server if provided)
      toEmail:  document.getElementById('toEmail').value || '',
      ccEmail:  document.getElementById('ccEmail').value || '',
      bccEmail: document.getElementById('bccEmail').value || '',
      subject:  document.getElementById('emailSubject').value || '',
      message:  document.getElementById('emailMessage').value || ''
    };

    submitBtn.disabled = true;
    try{
      const resp = await fetch(BACKEND_URL + '/api/osd/submit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const out = await resp.json().catch(()=> ({}));
      if(!resp.ok || out.ok === false) throw new Error(out.error || 'Submit failed');
      alertBox.innerHTML = `<div class="alert success">✅ Submitted! PDF emailed · Ref: ${out.ref || ''}</div>`;
      form.reset(); ctx.clearRect(0,0,canvas.width,canvas.height); window.signatureDataUrl=''; thumbs.innerHTML=''; bolPreview.innerHTML=''; bolPdfBadge.style.display='none'; bolPhotoDataUrl=''; bolPdfDataUrl='';
    }catch(err){
      console.error(err);
      alertBox.innerHTML = `<div class="alert error">❌ ${err.message}</div>`;
    }finally{
      submitBtn.disabled = false;
    }
  });
</script>
</body>
</html>
