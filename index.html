<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OSD – Driver Sign-Off</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#4f46e5}
  *{box-sizing:border-box}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:var(--ink);margin:0}
  .container{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
  h1{font-size:28px;margin:8px 0 16px}
  label{display:block;font-size:13px;color:#475569;margin:8px 0 6px}
  input,textarea,select{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff}
  input:focus,textarea:focus,select:focus{border-color:var(--brand)}
  .grid{display:grid;gap:12px}
  @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:#eef2ff;color:#111827;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
  .muted{color:#64748b;font-size:12px}
  .alert{padding:10px 14px;border-radius:12px;margin:10px 0;font-weight:600}
  .alert.success{background:#e8f7ee;border:1px solid #31a24c;color:#166534}
  .alert.error{background:#fdeaea;border:1px solid #dc2626;color:#7f1d1d}
  .sig{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .sigbar{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px 10px}
  #sigCanvas{display:block;width:100%;height:180px;background:#f9fafb;touch-action:none}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:100px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;background:#f8fafc}
  .hr{height:1px;background:#e5e7eb;margin:8px 0}
</style>
</head>
<body>
<div class="container">
  <h1>OSD – Driver Sign-Off</h1>
  <div id="alert"></div>

  <form id="osdForm" class="card" novalidate>
    <div class="grid grid-2">
      <div>
        <label>Date/Time</label>
        <input type="datetime-local" id="date"/>
      </div>
      <div>
        <label>Door Number *</label>
        <select id="doorNumber" required></select>
      </div>
    </div>

    <div class="row card" style="margin-top:12px">
      <div class="field small">
        <label for="bol">BOL #</label>
        <input id="bol" placeholder="BOL #"/>
      </div>
      <div class="field small">
        <label for="po">PO #</label>
        <input id="po" placeholder="PO #"/>
      </div>
      <div class="field">
        <label for="trailer">Trailer #</label>
        <input id="trailer" placeholder="Trailer #"/>
      </div>
      <div class="field">
        <label for="carrier">Carrier *</label>
        <input id="carrier" placeholder="Carrier" required/>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <label>Photo or PDF of BOL <span id="ocrStatus" class="muted"></span></label>
      <div class="row" style="gap:8px;align-items:center">
        <input type="file" id="bolFile" accept="image/*,application/pdf" capture="environment"/>
        <button type="button" class="btn-ghost" id="openCamera">Scan with Camera</button>
      </div>
      <div class="thumbs" id="bolPreview"></div>
      <div id="bolPdfBadge" class="pill" style="display:none">BOL PDF attached</div>

      <label style="margin-top:10px">Digital BOL Link / Load Number (optional)</label>
      <input type="text" id="bolLink" placeholder="Paste a link to the BOL or enter the load number"/>
    </div>

    <div class="row card" style="margin-top:12px">
      <div class="field small">
        <label for="vendorId">Vendor ID</label>
        <input id="vendorId" placeholder="Vendor ID"/>
      </div>
      <div class="field">
        <label for="vendorName">Vendor Name</label>
        <input id="vendorName" placeholder="Vendor Name"/>
      </div>
      <div class="field small">
        <label for="stop">Stop #</label>
        <input id="stop" placeholder="Stop #"/>
      </div>
    </div>

    <div class="card">
      <label>Notes / Exceptions</label>
      <textarea id="notes" rows="5" placeholder="Possible damages, shortages, and overages..."></textarea>
    </div>

    <div class="row">
      <div class="field">
        <label for="driverName">Driver Name *</label>
        <input id="driverName" required/>
      </div>
      <div class="field">
        <label for="proNumber">PRO # / Driver ID (optional)</label>
        <input id="proNumber" placeholder="PRO # or License"/>
      </div>
    </div>

    <div class="sig" style="margin-top:12px">
      <div class="sigbar">
        <span class="muted">Driver signature (draw in the box) *</span>
        <button type="button" class="btn-ghost" id="clearSig">Clear</button>
      </div>
      <canvas id="sigCanvas"></canvas>
    </div>

    <div style="margin-top:12px">
      <label>Photos (optional)</label>
      <input type="file" id="photos" multiple accept="image/*"/>
      <div class="thumbs" id="thumbs"></div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button type="button" class="btn-ghost" id="mailtoBtn">Send via Email App</button>
      <button class="btn" id="submitBtn">Submit (Generate & Email PDF)</button>
    </div>
  </form>
</div>

<script>
  /* ====== CONFIG ====== */
  const BACKEND_URL = "https://osd-webform.onrender.com";

  /* ====== UTIL ====== */
  const $ = id => document.getElementById(id);
  const alertBox = $('alert');
  const ocrStatus = $('ocrStatus');
  const bolInput = $('bolFile');
  const bolPreview = $('bolPreview');
  const bolPdfBadge = $('bolPdfBadge');
  const openCameraBtn = $('openCamera');

  const DOOR_GROUPS = [
    { label: '— Select Door —', options: [] },
    { label: 'Bixby Rd – Doors 1–26', options: Array.from({length:26}, (_,i)=>`Door ${i+1} – 6121 Bixby Rd, Canal Winchester OH 43110`) },
    { label: 'Bixby Rd (Alt Entry) – Doors 17–19', options: ['Door 17 – 6121 Bixby Rd, Canal Winchester OH 43110','Door 18 – 6121 Bixby Rd, Canal Winchester OH 43110','Door 19 – 6121 Bixby Rd, Canal Winchester OH 43110'] },
    { label: 'Other Building – Doors 1–26', options: Array.from({length:26}, (_,i)=>`Door ${i+1} – Other Building`) },
    { label: 'Generic – Doors 100–140', options: Array.from({length:41}, (_,i)=>`Door ${100+i}`) }
  ];

  function setStatus(msg){ ocrStatus.textContent = msg || ''; }
  function setAlert(kind,msg){
    alertBox.innerHTML = `<div class="alert ${kind==='error'?'error':'success'}">${msg}</div>`;
    setTimeout(()=>alertBox.innerHTML='', 6000);
  }
  function showThumb(url){
    const img = new Image();
    img.src = url;
    img.alt = 'BOL photo';
    bolPreview.innerHTML = '';
    bolPreview.appendChild(img);
  }
  function fill(id,val){ if(!val) return; const el=$(id); if(el && !el.value) el.value = String(val).trim(); }

  /* ====== PREFILL DATE ====== */
  (function prefillDate(){
    const d = new Date(), p = n => String(n).padStart(2,'0');
    const val = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    $('date').value = val;
  })();

  /* ====== FILL DOORS FROM GROUPS ====== */
  (function fillDoors(){
    const sel = $('doorNumber');
    DOOR_GROUPS.forEach((group,idx)=>{
      if(idx===0){
        const o=document.createElement('option');
        o.value=''; o.textContent=group.label;
        sel.appendChild(o);
        return;
      }
      const divider = document.createElement('option');
      divider.textContent = `--- ${group.label} ---`;
      divider.disabled = true;
      divider.style.fontStyle = 'italic';
      sel.appendChild(divider);
      group.options.forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
      });
    });
  })();

  /* ====== SIGNATURE PAD ====== */
  (function signaturePad(){
    const canvas = $('sigCanvas');
    const ctx = canvas.getContext('2d');
    let drawing=false, lastX=0, lastY=0;

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(ratio,ratio);
      ctx.lineWidth=2; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#111827';
    }
    window.addEventListener('resize', resize);
    resize();

    function pos(e){
      const r = canvas.getBoundingClientRect();
      if(e.touches && e.touches[0]) return {x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top};
      return {x: e.clientX - r.left, y: e.clientY - r.top};
    }
    function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
    function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
    function end(){ drawing=false; }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseout', end);

    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', end);

    $('clearSig').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); });
  })();

  /* ====== OCR: Parse BOL Fields from text ====== */
  function parseFields(text){
    const out = {};
    const t = text.replace(/\r/g,' ').replace(/\s{2,}/g,' ').trim();

    // BOL #
    let m = t.match(/(?:\bBOL\b|\bBill of Lading\b)\s*#?\s*[:\-]?\s*([A-Z0-9\-]{5,})/i);
    if(m) out.bol = m[1];

    // PO #
    m = t.match(/(?:\bPO\b|P\.?O\.?)\s*#?\s*[:\-]?\s*([A-Z0-9\-]+)/i);
    if(m) out.po = m[1];

    // Trailer #
    m = t.match(/(?:Trailer|Trlr|TRL)\s*#?\s*[:\-]?\s*([A-Z0-9\-]+)/i);
    if(m) out.trailer = m[1];

    // Carrier
    m = t.match(/(?:Carrier|Company)\s*[:\-]\s*([A-Za-z0-9&\.\-\s]{3,40})/i);
    if(m) out.carrier = m[1];

    // Vendor ID
    m = t.match(/(?:Vendor\s*ID|VendorID)\s*[:\-]?\s*([A-Z0-9\-]+)/i);
    if(m) out.vendorId = m[1];

    // Vendor Name
    m = t.match(/(?:Vendor\s*Name)\s*[:\-]\s*([A-Za-z0-9&\.\-\s]{3,80})/i);
    if(m) out.vendorName = m[1];

    // Stop #
    m = t.match(/\bStop\s*#?\s*[:\-]?\s*(\d{1,3})\b/i);
    if(m) out.stop = m[1];

    return out;
  }

  function applyParsed(out){
    fill('bol', out.bol);
    fill('po', out.po);
    fill('trailer', out.trailer);
    fill('carrier', out.carrier);
    fill('vendorId', out.vendorId);
    fill('vendorName', out.vendorName);
    fill('stop', out.stop);
  }

  /* ====== OCR Runner ====== */
  async function runImageOCR(file){
    setStatus('Scanning… (Tesseract.js)');
    try{
      const imgURL = URL.createObjectURL(file);
      showThumb(imgURL);

      const prepped = await downscaleImage(imgURL, 2200);

      const { data } = await Tesseract.recognize(prepped || imgURL, 'eng', {
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-:/#.'
      });

      const text = data.text || '';
      const parsed = parseFields(text);
      applyParsed(parsed);

      if(Object.keys(parsed).length){
        setAlert('success','BOL fields auto-filled from photo. Please review.');
      }else{
        setAlert('error','Could not detect standard fields. You can still type them manually.');
      }
      setStatus('');
      URL.revokeObjectURL(imgURL);
    }catch(err){
      console.error(err);
      setStatus('');
      setAlert('error','OCR failed. Try a clearer photo (flat, bright, no glare).');
    }
  }

  function isPDF(file){ return file && file.type === 'application/pdf'; }

  bolInput.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    if(isPDF(file)){
      bolPdfBadge.style.display = 'inline-block';
      bolPreview.innerHTML = '';
      setStatus('PDF attached. (Images are OCR’d in-browser; PDFs not auto-OCR’d here.)');
      // Optional: POST the PDF to your backend for server-side OCR.
      return;
    } else {
      bolPdfBadge.style.display = 'none';
      await runImageOCR(file);
    }
  });

  openCameraBtn.addEventListener('click', ()=> bolInput.click());

  // Downscale helper for speed
  function downscaleImage(url, maxW){
    return new Promise(resolve=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxW / img.width);
        if(scale >= 1){ resolve(null); return; }
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.85));
      };
      img.onerror = ()=>resolve(null);
      img.src = url;
    });
  }

  /* ====== OPTIONAL PHOTO THUMBS ====== */
  $('photos').addEventListener('change', e=>{
    const wrap = $('thumbs'); wrap.innerHTML='';
    const files = [...(e.target.files||[])];
    files.forEach(f=>{
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.src = url; img.alt = 'Photo';
      img.onload = ()=> URL.revokeObjectURL(url);
      wrap.appendChild(img);
    });
  });

  /* ====== MAILTO HANDOFF ====== */
  $('mailtoBtn').addEventListener('click', ()=>{
    const subject = encodeURIComponent('OSD Driver Sign-Off');
    const body = encodeURIComponent([
      `Date/Time: ${$('date').value}`,
      `Door: ${$('doorNumber').value}`,
      `BOL: ${$('bol').value}`,
      `PO: ${$('po').value}`,
      `Trailer: ${$('trailer').value}`,
      `Carrier: ${$('carrier').value}`,
      `Vendor ID: ${$('vendorId').value}`,
      `Vendor Name: ${$('vendorName').value}`,
      `Stop: ${$('stop').value}`,
      `Driver: ${$('driverName').value}`,
      `PRO/ID: ${$('proNumber').value}`,
      `BOL Link: ${$('bolLink').value}`,
      `Notes: ${$('notes').value}`
    ].join('\n'));
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  });

  /* ====== SUBMIT TO BACKEND ====== */
  $('submitBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      if(!$('doorNumber').value) return setAlert('error','Please select a Door Number.');
      if(!$('carrier').value) return setAlert('error','Carrier is required.');
      if(!$('driverName').value) return setAlert('error','Driver name is required.');

      const sigDataURL = $('sigCanvas').toDataURL('image/png');

      const fd = new FormData();
      fd.append('date', $('date').value || '');
      fd.append('doorNumber', $('doorNumber').value || '');
      fd.append('bol', $('bol').value || '');
      fd.append('po', $('po').value || '');
      fd.append('trailer', $('trailer').value || '');
      fd.append('carrier', $('carrier').value || '');
      fd.append('vendorId', $('vendorId').value || '');
      fd.append('vendorName', $('vendorName').value || '');
      fd.append('stop', $('stop').value || '');
      fd.append('notes', $('notes').value || '');
      fd.append('driverName', $('driverName').value || '');
      fd.append('proNumber', $('proNumber').value || '');
      fd.append('bolLink', $('bolLink').value || '');
      fd.append('signature', sigDataURL);

      if(bolInput.files && bolInput.files[0]){
        fd.append('bolFile', bolInput.files[0], bolInput.files[0].name);
      }
      const photos = $('photos').files || [];
      [...photos].forEach((f,i)=> fd.append('photos', f, f.name || `photo_${i}.jpg`));

      const btn = $('submitBtn');
      btn.disabled = true; btn.textContent = 'Submitting…';
      const res = await fetch(BACKEND_URL + '/submit', { method:'POST', body: fd });
      btn.disabled = false; btn.textContent = 'Submit (Generate & Email PDF)';

      if(!res.ok){
        const txt = await res.text().catch(()=> 'Request failed');
        throw new Error(txt || ('HTTP ' + res.status));
      }
      setAlert('success','Submitted. PDF should be generated/emailed by the server.');
    }catch(err){
      console.error(err);
      setAlert('error','Submit failed. If this persists, check BACKEND_URL or server logs.');
    }
  });
</script>
</body>
</html>